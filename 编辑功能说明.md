# 编辑功能修复说明

## 🔧 问题描述

原来的编辑功能只支持AI分析任务的编辑，没有适配新品监控任务类型。当用户点击新品监控任务的"编辑"按钮时，显示的编辑界面仍然是AI分析任务的字段，无法编辑新品监控特有的配置。

## ✅ 修复内容

### 1. 动态编辑界面生成

**修改前**：
- 硬编码的编辑HTML模板
- 只显示AI分析任务的字段
- 无法编辑新品监控特有配置

**修改后**：
- 根据任务类型动态生成编辑界面
- AI分析任务显示AI相关字段
- 新品监控任务显示监控相关字段

### 2. 新品监控任务编辑字段

新品监控任务的编辑界面包含以下特有字段：

| 字段 | 类型 | 说明 | 验证规则 |
|------|------|------|----------|
| 监控间隔 | number | 检查新商品的时间间隔（秒） | 最小60秒 |
| 新品窗口 | number | 新品时间窗口（秒） | 最小600秒 |
| 钉钉Webhook | text | 钉钉机器人地址 | 可选，留空使用默认 |

### 3. 字段验证逻辑

添加了新品监控任务特有的验证：

```javascript
// 监控间隔验证
const monitorIntervalInput = row.querySelector('input[data-field="monitor_interval"]');
if (monitorIntervalInput) {
    const interval = parseInt(monitorIntervalInput.value);
    if (interval < 60) {
        alert('监控间隔不能少于60秒(1分钟)。');
        return;
    }
}

// 新品窗口验证
const newProductWindowInput = row.querySelector('input[data-field="new_product_window"]');
if (newProductWindowInput) {
    const window = parseInt(newProductWindowInput.value);
    if (window < 600) {
        alert('新品时间窗口不能少于600秒(10分钟)。');
        return;
    }
}
```

## 🎨 界面改进

### 1. 任务类型标识

在编辑模式下也显示任务类型标识：
- 🤖 AI分析：蓝色标识
- 🆕 新品监控：绿色标识

### 2. 配置字段布局

新品监控任务的配置字段采用垂直布局：
```html
<div style="display: flex; flex-direction: column; gap: 4px;">
    <div>
        <label style="font-size: 12px;">监控间隔(秒):</label>
        <input type="number" value="300" min="60" style="width: 80px;">
    </div>
    <div>
        <label style="font-size: 12px;">新品窗口(秒):</label>
        <input type="number" value="3600" min="600" style="width: 80px;">
    </div>
    <div>
        <label style="font-size: 12px;">钉钉Webhook:</label>
        <input type="text" placeholder="留空使用默认" style="width: 200px;">
    </div>
</div>
```

### 3. 样式优化

添加了编辑模式下的样式：
```css
.tasks-table tr.editing input[type="number"] {
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    padding: 4px 6px;
    font-size: 12px;
}

.tasks-table tr.editing label {
    font-weight: normal;
    color: #666;
    margin-bottom: 2px;
}
```

## 🧪 测试验证

### 自动化测试

运行测试脚本验证编辑功能：
```bash
python test_edit_functionality.py
```

测试内容包括：
1. 创建新品监控任务
2. 编辑任务配置
3. 验证边界值
4. 确认编辑结果
5. 清理测试数据

### 手动测试步骤

1. **访问Web界面**：http://127.0.0.1:8000
2. **创建新品监控任务**：点击"🆕 新品监控任务"
3. **编辑任务**：
   - 点击任务列表中的"编辑"按钮
   - 修改监控间隔（如改为120秒）
   - 修改新品窗口（如改为7200秒）
   - 添加钉钉Webhook地址
   - 点击"保存"
4. **验证结果**：确认任务列表中显示更新后的配置

## 📋 支持的编辑操作

### AI分析任务

可编辑字段：
- ✅ 任务名称
- ✅ 搜索关键词
- ✅ 价格范围（最低价、最高价）
- ✅ 个人闲置筛选
- ✅ 启用/禁用状态
- ❌ AI标准文件（只读显示）

### 新品监控任务

可编辑字段：
- ✅ 任务名称
- ✅ 搜索关键词
- ✅ 价格范围（最低价、最高价）
- ✅ 个人闲置筛选
- ✅ 监控间隔（60秒以上）
- ✅ 新品时间窗口（600秒以上）
- ✅ 钉钉Webhook地址
- ✅ 启用/禁用状态

## 🔄 向后兼容性

- ✅ 现有AI分析任务的编辑功能不受影响
- ✅ 现有新品监控任务可以正常编辑
- ✅ 混合任务列表正常显示和编辑
- ✅ 保存逻辑兼容两种任务类型

## 🚨 注意事项

1. **监控间隔限制**：最小60秒，建议300秒以上
2. **新品窗口限制**：最小600秒，建议3600秒
3. **钉钉Webhook**：可选字段，留空使用环境变量配置
4. **实时生效**：编辑保存后立即生效，无需重启服务
5. **数据验证**：前端和后端都有验证，确保数据有效性

## 🎯 使用建议

### 编辑最佳实践

1. **监控间隔设置**：
   - 测试环境：60-120秒
   - 生产环境：300-600秒
   - 多任务并行：适当增加间隔

2. **新品窗口设置**：
   - 快速响应：1800秒（30分钟）
   - 平衡设置：3600秒（1小时）
   - 宽松设置：7200秒（2小时）

3. **钉钉配置**：
   - 全局配置：在.env文件中设置
   - 任务特定：在编辑界面中设置
   - 优先级：任务特定 > 全局配置

现在用户可以通过Web界面方便地编辑新品监控任务的所有配置参数，享受完整的任务管理体验。
