# 新品监控功能使用说明

## 功能概述

新品监控功能是在原有AI分析基础上新增的实时监控模块，可以持续监控电商平台最新发布的商品，并通过钉钉机器人实时推送通知。

## 主要特性

- ✅ 实时监控新发布商品（基于发布时间）
- ✅ 支持钉钉机器人通知（文本和Markdown格式）
- ✅ 智能去重机制，避免重复通知
- ✅ 可配置监控间隔和新品时间窗口（最小60秒）
- ✅ 支持价格筛选和个人闲置筛选
- ✅ 自动清理过期商品ID记录
- ✅ 完善的错误处理和重试机制
- ✅ 商品图片集成显示

## 配置说明

### 1. 环境配置

在 `.env` 文件中添加钉钉机器人配置：

```bash
# 钉钉机器人通知配置
DINGTALK_WEBHOOK="https://oapi.dingtalk.com/robot/send?access_token=your_access_token"
```

### 2. 任务配置

在 `config.json` 中添加新品监控任务：

```json
{
  "task_name": "iPhone新品监控",
  "task_type": "new_product_monitor",
  "enabled": true,
  "keyword": "iPhone",
  "personal_only": true,
  "min_price": "3000",
  "max_price": "8000",
  "monitor_interval": 1800,
  "new_product_window": 3600,
  "notification_types": ["dingtalk"],
  "dingtalk_webhook": "https://oapi.dingtalk.com/robot/send?access_token=your_token"
}
```

### 配置参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `task_name` | string | ✅ | 任务名称 |
| `task_type` | string | ✅ | 任务类型，设为 `"new_product_monitor"` |
| `enabled` | boolean | ✅ | 是否启用任务 |
| `keyword` | string | ✅ | 监控关键词 |
| `personal_only` | boolean | ❌ | 是否只监控个人闲置 |
| `min_price` | string | ❌ | 最低价格筛选 |
| `max_price` | string | ❌ | 最高价格筛选 |
| `monitor_interval` | number | ❌ | 监控间隔（秒），默认300（5分钟），最小60秒 |
| `new_product_window` | number | ❌ | 新品时间窗口（秒），默认3600（1小时） |
| `notification_types` | array | ❌ | 通知类型，目前支持 `["dingtalk"]` |
| `dingtalk_webhook` | string | ❌ | 钉钉机器人webhook地址 |

## 使用方法

### 1. 测试钉钉通知

运行测试脚本验证钉钉通知是否正常：

```bash
python test_dingtalk.py
```

### 2. 启动新品监控

```bash
python spider_v2.py
```

程序会自动识别配置文件中的新品监控任务并开始执行。

### 3. 停止监控

使用 `Ctrl+C` 可以优雅地停止所有监控任务。

## 通知消息格式

### Markdown格式（推荐）

```
## 🆕 发现新商品！

**商品名称**：iPhone 15 Pro Max 256GB

**价格**：¥7999

**卖家**：张三

**发货地区**：北京

**发布时间**：2024-01-15 14:30

**商品链接**：[点击查看](https://...)

**商品图片**：

![商品图片](https://img.alicdn.com/imgextra/...)

**推荐原因**：新品监控发现
```

### 文本格式

```
🆕 发现新商品！

商品：iPhone 15 Pro Max 256GB
价格：¥7999
卖家：张三
地区：北京
时间：2024-01-15 14:30
链接：https://...
原因：新品监控发现
```

## 注意事项

1. **监控频率**：
   - 最小监控间隔：60秒（1分钟）
   - 推荐间隔：300秒（5分钟）
   - 高频监控可能增加被反爬虫检测的风险
2. **新品窗口**：建议设置1-2小时的新品时间窗口，平衡及时性和准确性
3. **钉钉配置**：确保钉钉机器人webhook地址正确且有效
4. **图片显示**：商品图片会自动在钉钉通知中显示，确保网络可访问图片URL
5. **网络稳定**：监控任务需要稳定的网络连接，建议在服务器上运行
6. **资源消耗**：新品监控会持续运行，注意服务器资源使用情况

## 故障排除

### 常见问题

1. **钉钉通知发送失败**
   - 检查webhook地址是否正确
   - 确认钉钉机器人是否正常工作
   - 运行 `test_dingtalk.py` 进行测试

2. **未检测到新商品**
   - 检查关键词是否正确
   - 调整新品时间窗口大小
   - 确认价格筛选条件是否过于严格

3. **程序异常退出**
   - 查看控制台错误信息
   - 检查网络连接是否稳定
   - 确认登录状态文件是否有效

### 日志信息

程序运行时会输出详细的日志信息，包括：
- 监控任务启动信息
- 每轮检查的商品数量
- 新品发现和通知发送情况
- 错误和异常信息

## Web界面管理

### 1. 启动Web管理界面

```bash
python web_server.py
```

然后在浏览器中访问：http://127.0.0.1:8000

### 2. 创建新品监控任务

1. 点击任务管理页面的 **"🆕 新品监控任务"** 按钮
2. 填写以下信息：
   - **任务名称**：给任务起一个有意义的名称
   - **搜索关键词**：要监控的商品关键词
   - **价格范围**：可选的价格筛选条件
   - **监控间隔**：检查新商品的时间间隔（建议不少于5分钟）
   - **新品时间窗口**：只通知此时间内发布的商品
   - **钉钉Webhook**：可选，留空则使用环境变量配置
   - **个人闲置筛选**：是否只监控个人卖家

3. 点击 **"创建监控任务"** 完成创建

### 3. 管理监控任务

- **启用/禁用**：通过任务列表中的开关控制任务状态
- **编辑任务**：点击编辑按钮修改任务配置
- **删除任务**：点击删除按钮移除不需要的任务
- **查看日志**：在运行日志页面查看监控状态

### 4. 任务类型识别

在任务列表中，不同类型的任务有不同的标识：
- **🤖 AI分析**：传统的AI驱动分析任务
- **🆕 新品监控**：新的实时新品监控任务

## 测试功能

### 1. 测试钉钉通知

```bash
python test_dingtalk.py
```

### 2. 测试前端集成

```bash
# 先启动Web服务器
python web_server.py

# 在另一个终端运行测试
python test_frontend.py
```

## 完整工作流程

### 开发环境设置

1. **配置钉钉机器人**
   - 在钉钉群中添加自定义机器人
   - 获取webhook地址
   - 更新.env文件中的DINGTALK_WEBHOOK

2. **测试通知功能**
   ```bash
   python test_dingtalk.py
   ```

3. **启动Web管理界面**
   ```bash
   python web_server.py
   ```

4. **创建新品监控任务**
   - 访问 http://127.0.0.1:8000
   - 创建新品监控任务
   - 配置监控参数

5. **启动监控**
   ```bash
   python spider_v2.py
   ```

### 生产环境部署

1. **服务器配置**
   - 确保服务器有稳定的网络连接
   - 安装所需的Python依赖
   - 配置环境变量

2. **后台运行**
   ```bash
   # 使用nohup后台运行
   nohup python spider_v2.py > monitor.log 2>&1 &

   # 或使用screen/tmux
   screen -S monitor
   python spider_v2.py
   ```

3. **监控管理**
   - 通过Web界面管理任务
   - 查看运行日志
   - 调整监控参数

## 扩展功能

未来可能添加的功能：
- ✅ Web界面管理和监控
- 支持更多通知渠道（企业微信、邮件等）
- 商品图片在通知中的展示
- 更智能的监控频率调整
- 监控效果统计和分析
- 多平台支持（淘宝、京东等）
- 价格变动监控
- 库存监控
